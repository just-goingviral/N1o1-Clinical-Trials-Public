{% extends "base.html" %}

{% block title %}Patient Details - {{ patient.name }}{% endblock %}

{% block head %}
<style>
  .patient-header {
    background: linear-gradient(120deg, #212529, #343a40);
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
  }
  
  .patient-header::before {
    content: "";
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(13, 110, 253, 0.05) 0%, rgba(13, 110, 253, 0) 70%);
    z-index: 0;
  }
  
  .patient-name {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 1;
  }
  
  .patient-id {
    color: #6c757d;
    font-size: 1rem;
    margin-bottom: 1.5rem;
    position: relative;
    z-index: 1;
  }
  
  .stat-card {
    border-radius: 1rem;
    transition: transform 0.3s, box-shadow 0.3s;
    height: 100%;
    background: linear-gradient(145deg, #2c3034, #212529);
    border: none;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
  }
  
  .stat-value {
    font-size: 2rem;
    font-weight: 700;
  }
  
  .stat-label {
    color: #adb5bd;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .stat-icon {
    font-size: 2.5rem;
    opacity: 0.15;
    position: absolute;
    top: 1rem;
    right: 1rem;
  }
  
  .biomarker-value {
    font-weight: 700;
    color: #0d6efd;
  }
  
  .simulation-card {
    transition: transform 0.3s;
    border-left: 4px solid #0d6efd;
    background: linear-gradient(145deg, #2c3034, #212529);
    border-radius: 0.5rem;
  }
  
  .simulation-card:hover {
    transform: translateX(5px);
  }
  
  .simulation-date {
    font-size: 0.85rem;
    color: #adb5bd;
  }
  
  .notes-card {
    background: linear-gradient(145deg, #2c3034, #212529);
    border-radius: 1rem;
    height: 100%;
  }
  
  .notes-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    padding-bottom: 0.75rem;
    margin-bottom: 1rem;
  }
  
  .notes-content {
    white-space: pre-line;
    font-style: italic;
    color: #adb5bd;
  }
  
  .placeholder-text {
    color: #6c757d;
    font-style: italic;
  }
  
  .action-button {
    border-radius: 50px;
    padding: 0.5rem 1.25rem;
    font-weight: 600;
    transition: all 0.3s;
  }
  
  .action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }
  
  .btn-nitro {
    background-color: #17a2b8;
    border-color: #17a2b8;
    color: white;
  }
  
  .btn-nitro:hover {
    background-color: #138496;
    border-color: #117a8b;
    color: white;
  }
  
  /* NO Animation */
  .no-molecule {
    position: absolute;
    bottom: 1rem;
    right: 2rem;
    width: 80px;
    height: 80px;
    opacity: 0.1;
    z-index: 0;
  }
  
  .baseline-indicator {
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
    overflow: hidden;
    margin-top: 5px;
  }
  
  .baseline-marker {
    height: 16px;
    width: 8px;
    background-color: white;
    border-radius: 4px;
    position: relative;
    top: -4px;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  {% if error %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endif %}
  
  <!-- Patient Header Section -->
  <div class="patient-header position-relative">
    <div class="row">
      <div class="col-md-8">
        <div class="d-flex align-items-center mb-2">
          <h1 class="patient-name mb-0">{{ patient.name }}</h1>
          <div class="ms-3">
            <span class="badge bg-primary rounded-pill">Patient</span>
          </div>
        </div>
        <p class="patient-id">ID: {{ patient.id }} ‚Ä¢ Created: {{ patient.created_at.strftime('%B %d, %Y') }}</p>
        
        <div class="d-flex mt-4">
          <a href="{{ url_for('patients.edit_patient', patient_id=patient.id) }}" class="btn btn-outline-light action-button me-2">
            <i class="fas fa-edit me-1"></i> Edit Patient
          </a>
          <a href="{{ url_for('simulations.new_simulation', patient_id=patient.id) }}" class="btn btn-primary action-button me-2">
            <i class="fas fa-chart-line me-1"></i> New Simulation
          </a>
          <button type="button" class="btn btn-nitro action-button" onclick="document.getElementById('no-molecule-chat-button').click()">
            <i class="fas fa-flask me-1"></i> N1O1 Guidance
          </button>
          
          <!-- Patient Education Chat Widget -->
          <div id="patient-chat-box" style="display: none; position: fixed; bottom: 20px; right: 20px; width: 350px; 
                                          background: #fff; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
                                          z-index: 1000; padding: 15px; max-height: 500px; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h3 style="margin: 0;">üí¨ Ask N1O1 Coach</h3>
              <button onclick="togglePatientChat()" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
            </div>
            <textarea id="patient-question" placeholder="Type your question..." rows="3" style="width:100%; margin-bottom: 10px;"></textarea>
            <button onclick="submitPatientQuestion()" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Ask</button>
            <p id="patient-response" style="margin-top:10px; font-style:italic;"></p>
          </div>
          
          <form method="POST" action="{{ url_for('patients.delete_patient', patient_id=patient.id) }}" class="ms-auto" onsubmit="return confirm('Are you sure you want to delete this patient? This action cannot be undone.');">
            <button type="submit" class="btn btn-outline-danger action-button">
              <i class="fas fa-trash-alt me-1"></i> Delete
            </button>
          </form>
        </div>
      </div>
      
      <div class="col-md-4 position-relative">
        <!-- NO Molecule Animation -->
        <svg class="no-molecule" viewBox="0 0 60 60">
          <circle cx="22" cy="30" r="12" fill="#3b7eb9" />
          <circle cx="42" cy="30" r="10" fill="#e05a47" />
          <path d="M 22 30 L 42 30" stroke="#ffffff" stroke-width="3" stroke-dasharray="3,2" />
          <circle cx="22" cy="30" r="14" fill="none" stroke="#ffffff" stroke-width="1" stroke-opacity="0.5" />
          <circle cx="42" cy="30" r="12" fill="none" stroke="#ffffff" stroke-width="1" stroke-opacity="0.5" />
          <text x="22" y="34" font-family="Arial" font-size="12" fill="#ffffff" text-anchor="middle">N</text>
          <text x="42" y="34" font-family="Arial" font-size="12" fill="#ffffff" text-anchor="middle">O</text>
        </svg>
      </div>
    </div>
  </div>
  
  <!-- Patient Stats Cards -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card stat-card">
        <div class="card-body p-4 position-relative">
          <i class="fas fa-user-circle stat-icon"></i>
          <div class="stat-label">Age</div>
          <div class="stat-value">{{ patient.age }}</div>
          <div class="mt-3 small">
            <i class="fas fa-info-circle text-info me-1"></i> 
            {% if patient.age < 30 %}
            Young adult
            {% elif patient.age < 60 %}
            Middle-aged adult
            {% else %}
            Senior adult
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card stat-card">
        <div class="card-body p-4 position-relative">
          <i class="fas fa-weight stat-icon"></i>
          <div class="stat-label">Weight</div>
          <div class="stat-value">{{ patient.weight_kg }} <span class="fs-6">kg</span></div>
          <div class="mt-3 small">
            <i class="fas fa-info-circle text-info me-1"></i> 
            {% set bmi = patient.weight_kg / ((patient.height_cm if patient.height_cm else 170) / 100) ** 2 %}
            {% if bmi < 18.5 %}
            Underweight range
            {% elif bmi < 25 %}
            Healthy weight range
            {% elif bmi < 30 %}
            Overweight range
            {% else %}
            Obese range
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card stat-card">
        <div class="card-body p-4 position-relative">
          <i class="fas fa-flask stat-icon"></i>
          <div class="stat-label">Baseline NO‚ÇÇ‚Åª</div>
          <div class="stat-value">{{ patient.baseline_no2 }} <span class="fs-6">¬µM</span></div>
          <div class="mt-2">
            <div class="d-flex justify-content-between small mb-1">
              <span>Low</span>
              <span>Normal</span>
              <span>High</span>
            </div>
            <div class="baseline-indicator">
              <div class="baseline-marker" style="margin-left: {{ (patient.baseline_no2 / 1.0) * 100 }}%;"></div>
            </div>
            <div class="mt-2 small text-end">
              <i class="fas fa-info-circle text-info me-1"></i> 
              {% if patient.baseline_no2 < 0.1 %}
              Below average
              {% elif patient.baseline_no2 < 0.3 %}
              Normal range
              {% else %}
              Above average
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row g-4">
    <!-- Clinical Notes -->
    <div class="col-md-6">
      <div class="card notes-card h-100">
        <div class="card-body p-4">
          <div class="notes-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i> Clinical Notes</h5>
            <a href="{{ url_for('notes.new_note', patient_id=patient.id) }}" class="btn btn-sm btn-outline-light">
              <i class="fas fa-plus"></i> Add Note
            </a>
          </div>
          
          {% if patient.notes %}
          <div class="notes-content">{{ patient.notes }}</div>
          {% else %}
          <p class="placeholder-text">No clinical notes have been added yet.</p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Simulations History -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Simulation History</h5>
          <a href="{{ url_for('simulations.new_simulation', patient_id=patient.id) }}" class="btn btn-sm btn-primary">
            <i class="fas fa-plus"></i> New Simulation
          </a>
        </div>
        <div class="card-body p-0">
          {% if simulations %}
          <div class="list-group list-group-flush">
            {% for sim in simulations %}
            <a href="{{ url_for('simulations.view_simulation', id=sim.id) }}" class="list-group-item list-group-item-action border-0 simulation-card mx-2 my-1">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">{{ sim.model_type }}</h6>
                  <p class="mb-1 small">Peak NO‚ÇÇ‚Åª: <span class="biomarker-value">{{ sim.parameters.get('peak', '?') }} ¬µM</span></p>
                  <div class="simulation-date">
                    <i class="far fa-calendar-alt me-1"></i> {{ sim.created_at.strftime('%B %d, %Y') }}
                  </div>
                </div>
                <i class="fas fa-chevron-right text-muted"></i>
              </div>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <div class="p-4 text-center">
            <p class="placeholder-text">No simulations have been run for this patient.</p>
            <a href="{{ url_for('simulations.new_simulation', patient_id=patient.id) }}" class="btn btn-primary mt-2">
              <i class="fas fa-flask me-1"></i> Run First Simulation
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <div class="mt-4">
    <a href="{{ url_for('patients.list_patients') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i> Back to Patient List
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize any interactive elements
    
    // Add slight animation to NO molecule
    const noMolecule = document.querySelector('.no-molecule');
    if (noMolecule) {
      setInterval(() => {
        const randomScale = 0.95 + Math.random() * 0.1;
        const randomRotate = -5 + Math.random() * 10;
        noMolecule.style.transform = `scale(${randomScale}) rotate(${randomRotate}deg)`;
      }, 2000);
    }
  });
  
  // Patient Education Chat functions
  function togglePatientChat() {
    const chatBox = document.getElementById('patient-chat-box');
    if (chatBox.style.display === 'none' || !chatBox.style.display) {
      chatBox.style.display = 'block';
    } else {
      chatBox.style.display = 'none';
    }
  }
  
  function submitPatientQuestion() {
    const question = document.getElementById('patient-question').value;
    const responseElement = document.getElementById('patient-response');
    
    if (!question.trim()) {
      responseElement.innerText = "Please enter a question.";
      return;
    }
    
    responseElement.innerText = "Thinking...";
    
    fetch('/chat/patient', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        question: question, 
        name: "{{ patient.name }}" 
      })
    })
    .then(res => res.json())
    .then(data => {
      responseElement.innerText = data.reply || "No response from assistant.";
    })
    .catch(err => {
      console.error("Error:", err);
      responseElement.innerText = "Error talking to N1O1 Coach. Please try again.";
    });
  }
  
  // Add chat toggle to N1O1 Guidance button
  document.querySelector('.btn-nitro').addEventListener('click', function(e) {
    e.preventDefault();
    togglePatientChat();
  });
</script>
{% endblock %}