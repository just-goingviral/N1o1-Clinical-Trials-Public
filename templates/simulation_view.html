<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N1O1 Clinical Trials - Simulation Visualization</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-bottom: 2rem;
        }
        .parameter-card {
            border-left: 4px solid var(--bs-info);
            margin-bottom: 1rem;
        }
        .patient-info {
            background-color: rgba(13, 110, 253, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .no-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            background-color: rgba(128, 128, 128, 0.1);
            border-radius: 0.5rem;
            font-size: 1.5rem;
            color: var(--bs-secondary);
        }
    </style>
</head>
<body data-bs-theme="dark">
    <div class="container">
        <header class="pb-3 mb-4 border-bottom">
            <h1 class="display-5 fw-bold">N1O1 Clinical Trials</h1>
            <p class="lead">Nitric Oxide (NO) Plasma Level Simulation</p>
        </header>

        <div class="row">
            <div class="col-lg-8">
                <div class="p-4 mb-4 bg-dark rounded-3">
                    <h2 class="mb-4">Nitrite Level Simulation</h2>
                    
                    {% if simulation %}
                    <div class="chart-container">
                        <canvas id="nitriteChart"></canvas>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="p-3 parameter-card">
                                <h4>Kinetic Parameters</h4>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item bg-transparent">Baseline NO₂⁻: {{ simulation.parameters.baseline }} µM</li>
                                    <li class="list-group-item bg-transparent">Peak NO₂⁻: {{ simulation.parameters.peak|round(2) }} µM</li>
                                    <li class="list-group-item bg-transparent">Time to Peak: {{ simulation.parameters.peak_time }} minutes</li>
                                    <li class="list-group-item bg-transparent">Half-life: {{ simulation.parameters.half_life|round(2) }} hours</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 parameter-card">
                                <h4>Simulation Settings</h4>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item bg-transparent">Model Type: {{ simulation.model_type }}</li>
                                    <li class="list-group-item bg-transparent">Dose: {{ simulation.parameters.dose }} mg</li>
                                    <li class="list-group-item bg-transparent">Simulation ID: {{ simulation.id }}</li>
                                    <li class="list-group-item bg-transparent">Created: {{ simulation.created_at.strftime('%Y-%m-%d %H:%M') }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h4>Download Options</h4>
                        <div class="btn-group mb-3" role="group">
                            <button type="button" class="btn btn-outline-info" id="downloadCSV">CSV Data</button>
                            <button type="button" class="btn btn-outline-info" id="downloadImage">Chart Image</button>
                            <button type="button" class="btn btn-outline-info" id="downloadReport">Full Report</button>
                        </div>
                        
                        <h4 class="mt-3">Research Documentation</h4>
                        <div class="card border-info">
                            <div class="card-body">
                                <h5 class="card-title">One-Click Research Capture</h5>
                                <p class="card-text">Capture this simulation data and screenshot for your research documentation.</p>
                                
                                <div class="form-group mb-3">
                                    <label for="researchNotes" class="form-label">Research Notes</label>
                                    <textarea class="form-control" id="researchNotes" rows="3" placeholder="Add notes about this simulation for your research documentation..."></textarea>
                                </div>
                                
                                <button type="button" class="btn btn-primary w-100" id="captureResearch">
                                    <i class="fas fa-camera me-2"></i> Capture for Research
                                </button>
                            </div>
                        </div>
                        
                        <!-- Success Modal -->
                        <div class="modal fade" id="captureSuccessModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-white">
                                        <h5 class="modal-title">Research Documentation Captured</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="text-center mb-3">
                                            <i class="fas fa-check-circle text-success" style="font-size: 48px;"></i>
                                        </div>
                                        <p>Your research documentation has been saved successfully.</p>
                                        <div id="captureDetails">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Simulation ID:</span>
                                                <span id="captureSimId"></span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Timestamp:</span>
                                                <span id="captureTimestamp"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <a href="#" class="btn btn-primary" id="viewCapturedData">View Data</a>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% else %}
                    <div class="no-data">
                        <div class="text-center">
                            <p>No simulation data available.</p>
                            <a href="/api/simulate" class="btn btn-primary mt-3">Run a Simulation</a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="col-lg-4">
                {% if patient %}
                <div class="p-4 mb-4 bg-dark rounded-3">
                    <h3>Patient Information</h3>
                    <div class="patient-info">
                        <h4>{{ patient.name }}</h4>
                        <ul class="list-unstyled">
                            <li><strong>Age:</strong> {{ patient.age }} years</li>
                            <li><strong>Weight:</strong> {{ patient.weight_kg }} kg</li>
                            <li><strong>Baseline NO₂⁻:</strong> {{ patient.baseline_no2 }} µM</li>
                        </ul>
                        <p><small>{{ patient.notes }}</small></p>
                    </div>
                </div>
                {% endif %}

                <div class="p-4 mb-4 bg-dark rounded-3">
                    <h3>Simulation Controls</h3>
                    <form action="/api/simulate" method="post" id="simulationForm">
                        <div class="mb-3">
                            <label for="patientSelect" class="form-label">Patient</label>
                            <select class="form-select" id="patientSelect" name="patient_id">
                                <option value="">-- Custom Simulation --</option>
                                <!-- Will be populated via API -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modelType" class="form-label">
                                Model Type
                                <i class="fas fa-info-circle ms-1 text-info" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="right" 
                                   title="Pharmacokinetic (PK) model to simulate how nitric oxide levels change over time. Different models account for varying levels of complexity in absorption, distribution, and elimination processes."></i>
                            </label>
                            <select class="form-select" id="modelType" name="model_type">
                                <option value="1-compartment PK">1-Compartment PK (Simple)</option>
                                <option value="2-compartment PK">2-Compartment PK (Advanced)</option>
                                <option value="HillTau">HillTau (Enzyme Kinetics)</option>
                            </select>
                            <small class="form-text text-muted">Select the mathematical model used to simulate nitrite dynamics.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dose" class="form-label">Dose (mg)</label>
                            <input type="number" class="form-control" id="dose" name="dose" value="30" min="0" max="1000">
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Run Simulation</button>
                    </form>
                </div>

                <div class="p-4 mb-4 bg-dark rounded-3">
                    <h3>Need Help?</h3>
                    <p>Ask the N1O1ai Assistant about simulation parameters or how to interpret results.</p>
                    <button id="openChatBtn" class="btn btn-outline-info w-100">
                        <i class="fas fa-comment-alt me-2"></i> Ask N1O1ai
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load patients for the dropdown
            fetch('/patients/')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const patientSelect = document.getElementById('patientSelect');
                        data.data.forEach(patient => {
                            const option = document.createElement('option');
                            option.value = patient.id;
                            option.textContent = `${patient.name} (${patient.age}y, ${patient.weight_kg}kg)`;
                            patientSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error loading patients:', error));
            
            // Handle form submission via AJAX
            const simulationForm = document.getElementById('simulationForm');
            if (simulationForm) {
                simulationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        patient_id: document.getElementById('patientSelect').value,
                        model_type: document.getElementById('modelType').value,
                        dose: parseFloat(document.getElementById('dose').value)
                    };
                    
                    if (formData.patient_id === '') {
                        delete formData.patient_id;
                    } else {
                        formData.patient_id = parseInt(formData.patient_id);
                    }
                    
                    fetch('/api/simulate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success' && data.data.simulation_id) {
                            window.location.href = `/simulations/view?id=${data.data.simulation_id}`;
                        } else {
                            alert('Simulation was successful, but no simulation ID was returned.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('There was an error running the simulation.');
                    });
                });
            }
            
            // Initialize the chart if we have simulation data
            {% if simulation %}
            const ctx = document.getElementById('nitriteChart').getContext('2d');
            
            // Use the time and nitrite data provided by the route
            const timePoints = {{ simulation.result_curve.time|tojson }};
            const nitriteValues = {{ simulation.result_curve.no2|tojson }};
            
            console.log('Time points:', timePoints);
            console.log('Nitrite values:', nitriteValues);
            
            // Create the chart
            const nitriteChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timePoints,
                    datasets: [{
                        label: 'Plasma NO₂⁻ (µM)',
                        data: nitriteValues,
                        fill: true,
                        backgroundColor: 'rgba(13, 110, 253, 0.2)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (minutes)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Plasma NO₂⁻ (µM)'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'N1O1 Clinical Trials Simulation',
                            font: {
                                size: 18
                            }
                        },
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `NO₂⁻: ${context.parsed.y.toFixed(2)} µM`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Handle download buttons
            document.getElementById('downloadCSV').addEventListener('click', function() {
                // Create CSV content
                let csvContent = 'Time (minutes),Plasma NO₂⁻ (µM)\n';
                for (let i = 0; i < timePoints.length; i++) {
                    csvContent += `${timePoints[i]},${nitriteValues[i]}\n`;
                }
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'n1o1_simulation_{{ simulation.id }}.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            document.getElementById('downloadImage').addEventListener('click', function() {
                const canvas = document.getElementById('nitriteChart');
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;
                link.download = 'n1o1_simulation_{{ simulation.id }}.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            document.getElementById('downloadReport').addEventListener('click', function() {
                const simulationId = {{ simulation.id }};
                const patientId = {{ simulation.patient_id if simulation.patient_id else 'null' }};
                const simulationTime = new Date().toLocaleString();
                
                // Generate PDF report using jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(18);
                doc.text('N1O1 Clinical Trials - Simulation Report', 15, 15);
                
                // Add report info
                doc.setFontSize(12);
                doc.text(`Simulation ID: ${simulationId}`, 15, 30);
                doc.text(`Generated: ${simulationTime}`, 15, 37);
                doc.text(`Patient ID: ${patientId !== null ? patientId : 'N/A'}`, 15, 44);
                
                // Add model information
                doc.setFontSize(14);
                doc.text('Simulation Parameters', 15, 55);
                doc.setFontSize(11);
                doc.text(`Model Type: {{ simulation.model_type }}`, 20, 62);
                
                {% if simulation.parameters %}
                const parameters = {{ simulation.parameters|tojson }};
                let yPos = 69;
                for (const [key, value] of Object.entries(parameters)) {
                    doc.text(`${key}: ${value}`, 20, yPos);
                    yPos += 7;
                }
                {% endif %}
                
                // Add chart image
                const canvas = document.getElementById('nitriteChart');
                const chartImage = canvas.toDataURL('image/png');
                doc.addImage(chartImage, 'PNG', 15, 120, 180, 100);
                
                // Add results summary
                doc.addPage();
                doc.setFontSize(14);
                doc.text('Simulation Results Summary', 15, 15);
                
                doc.setFontSize(11);
                const { baseline, peak, time_to_peak, half_life } = getSimulationMetrics();
                doc.text(`Baseline NO2- (µM): ${baseline.toFixed(2)}`, 15, 25);
                doc.text(`Peak NO2- (µM): ${peak.toFixed(2)}`, 15, 32);
                doc.text(`Time to Peak (hours): ${time_to_peak.toFixed(2)}`, 15, 39);
                doc.text(`Elimination Half-life (hours): ${half_life.toFixed(2)}`, 15, 46);
                
                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(10);
                    doc.text(`N1O1 Clinical Trials - Page ${i} of ${pageCount}`, 15, 285);
                    doc.text(`© Dr. Nathan Bryan - JustGoingViral - ${new Date().getFullYear()}`, 120, 285);
                }
                
                // Save the PDF
                const fileName = `N1O1_Simulation_${simulationId}_Report.pdf`;
                doc.save(fileName);
            });
            
            // Research Documentation Capture
            const captureResearchBtn = document.getElementById('captureResearch');
            const captureSuccessModal = new bootstrap.Modal(document.getElementById('captureSuccessModal'));
            
            if (captureResearchBtn) {
                captureResearchBtn.addEventListener('click', function() {
                    // Get the chart canvas as an image
                    const canvas = document.getElementById('nitriteChart');
                    const screenshot = canvas.toDataURL('image/png');
                    
                    // Get the research notes
                    const notes = document.getElementById('researchNotes').value.trim();
                    
                    // Create the data to send
                    const captureData = {
                        simulation_id: {{ simulation.id }},
                        screenshot: screenshot,
                        notes: notes
                    };
                    
                    // Show loading indicator
                    captureResearchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Capturing...';
                    captureResearchBtn.disabled = true;
                    
                    // Send the data to the server
                    fetch('/api/capture-research', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(captureData),
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Reset button
                        captureResearchBtn.innerHTML = '<i class="fas fa-camera me-2"></i> Capture for Research';
                        captureResearchBtn.disabled = false;
                        
                        if (data.status === 'success') {
                            // Update the modal with the capture details
                            document.getElementById('captureSimId').textContent = data.data.simulation_id;
                            document.getElementById('captureTimestamp').textContent = data.data.timestamp;
                            
                            // Set the link to view the captured data
                            const viewDataLink = document.getElementById('viewCapturedData');
                            viewDataLink.href = data.data.simulation_data_path;
                            
                            // Show the success modal
                            captureSuccessModal.show();
                            
                            // Clear the notes field
                            document.getElementById('researchNotes').value = '';
                        } else {
                            alert('Error capturing research documentation: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        captureResearchBtn.innerHTML = '<i class="fas fa-camera me-2"></i> Capture for Research';
                        captureResearchBtn.disabled = false;
                        alert('There was an error capturing the research documentation.');
                    });
                });
            }
            {% endif %}
            
            // Make the research capture button responsive
            const mediaQuery = window.matchMedia('(max-width: 768px)');
            
            function handleMobileChanges(e) {
                const captureResearchBtn = document.getElementById('captureResearch');
                if (captureResearchBtn) {
                    if (e.matches) {
                        // Mobile view
                        captureResearchBtn.innerHTML = '<i class="fas fa-camera"></i>';
                        captureResearchBtn.classList.add('btn-floating');
                        captureResearchBtn.style.position = 'fixed';
                        captureResearchBtn.style.bottom = '30px';
                        captureResearchBtn.style.right = '30px';
                        captureResearchBtn.style.width = '60px';
                        captureResearchBtn.style.height = '60px';
                        captureResearchBtn.style.borderRadius = '50%';
                        captureResearchBtn.style.zIndex = '999';
                        captureResearchBtn.style.padding = '0';
                        captureResearchBtn.style.display = 'flex';
                        captureResearchBtn.style.alignItems = 'center';
                        captureResearchBtn.style.justifyContent = 'center';
                        captureResearchBtn.style.boxShadow = '0 4px 10px rgba(0,0,0,0.3)';
                    } else {
                        // Desktop view
                        captureResearchBtn.innerHTML = '<i class="fas fa-camera me-2"></i> Capture for Research';
                        captureResearchBtn.classList.remove('btn-floating');
                        captureResearchBtn.style = '';
                    }
                }
            }
            
            // Check on load
            handleMobileChanges(mediaQuery);
            
            // Listen for changes
            mediaQuery.addEventListener('change', handleMobileChanges);
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
            
            // Handle N1O1ai chat button
            const openChatBtn = document.getElementById('openChatBtn');
            if (openChatBtn) {
                openChatBtn.addEventListener('click', function() {
                    // Find the NO molecule chat button and trigger a click on it
                    const noChatButton = document.getElementById('no-molecule-chat-button');
                    if (noChatButton) {
                        noChatButton.click();
                        
                        // Add a predefined question about model types after a delay
                        setTimeout(() => {
                            const chatInput = document.getElementById('no-chat-input');
                            const sendBtn = document.getElementById('no-chat-send');
                            
                            if (chatInput && sendBtn) {
                                chatInput.value = "Can you explain the different model types for nitric oxide simulations?";
                                sendBtn.click();
                            }
                        }, 1000);
                    } else {
                        alert("Chat assistant is not available. Please try again later.");
                    }
                });
            }
        });
    </script>
</body>
</html>